<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="two_dof_robot">

  <!-- Whether or not to use PID control -->
  <xacro:arg name="use_pid" default="false"/>
  <xacro:arg name="headless" default="false"/>
  <xacro:arg name="use_mjcf_from_topic" default="false"/>

  <link name="world"/>

  <link name="base"/>
  <joint name="base_link" type="fixed">
    <axis rpy="0 0 0" xyz="0 0 0"/>
    <parent link="world"/>
    <child link="base"/>
  </joint>

  <link name="upperarm">
    <inertial>
      <origin xyz="0.5 0 0" rpy="0 0 0"/>
      <mass value="27.0"/>
      <inertia ixx="0.0225" ixy="0.0" ixz="0.0" iyy="0.225" iyz="0.0" izz="0.225"/>
    </inertial>
    <visual>
      <geometry>
        <box size="1.0 0.1 0.1"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0.5 0 0"/>
      <material name="red">
        <color rgba="1.0 0 0 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <box size="1.0 0.1 0.1"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0.5 0 0"/>
    </collision>
  </link>
  <joint name="joint1" type="revolute">
    <axis rpy="0 0 0" xyz="0 0 1"/>
    <parent link="base"/>
    <child link="upperarm"/>
    <limit lower="-3.14" upper="3.14" velocity="3.14" effort="1000" />
  </joint>

  <link name="forearm">
    <inertial>
      <origin xyz="0.5 0 0" rpy="0 0 0"/>
      <mass value="27.0"/>
      <inertia ixx="0.0225" ixy="0.0" ixz="0.0" iyy="0.225" iyz="0.0" izz="0.225"/>
    </inertial>
    <visual>
      <geometry>
        <box size="1.0 0.1 0.1"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0.5 0 0"/>
      <material name="blue">
        <color rgba="0 0 1.0 1.0"/>
      </material>
    </visual>
    <collision>
      <geometry>
        <box size="1.0 0.1 0.1"/>
      </geometry>
      <origin rpy="0 0 0" xyz="0.5 0 0"/>
    </collision>
  </link>
  <joint name="joint2" type="revolute">
    <axis rpy="0 0 0" xyz="0 0 1"/>
    <parent link="upperarm"/>
    <child link="forearm"/>
    <origin rpy="0 0 0" xyz="1 0 0"/>
    <limit lower="-3.14" upper="3.14" velocity="3.14" effort="1000" />
  </joint>

  <link name="ee_link" />
  <joint name="ee_joint" type="fixed">
    <parent link="forearm"/>
    <child link="ee_link"/>
    <origin rpy="0 0 0" xyz="1 0 0"/>
  </joint>

  <link name="camera_link">
    <visual>
      <geometry>
        <box size="0.1 0.1 0.1" />
      </geometry>
      <material name="dark_grey">
        <color rgba="0.2 0.2 0.2 1.0"/>
      </material>
    </visual>
  </link>
  <joint name="camera_joint" type="fixed">
    <parent link="ee_link"/>
    <child link="camera_link"/>
    <origin xyz="0.05 0 0.1" rpy="0 0 0"/>
  </joint>

  <link name="camera_color_frame"/>
  <joint name="camera_color_joint" type="fixed">
    <parent link="camera_link"/>
    <child link="camera_color_frame"/>
    <origin xyz="-0.05 0 0" rpy="0 0 0"/>
  </joint>

  <!-- The camera looks backwards along the axis of the forearm, following the standard ROS image conventions -->
  <!-- https://github.com/ros2/common_interfaces/blob/rolling/sensor_msgs/msg/Image.msg#L7 -->
  <link name="camera_color_optical_frame"/>
  <joint name="camera_color_optical_joint" type="fixed">
    <parent link="camera_color_frame"/>
    <child link="camera_color_optical_frame"/>
    <origin xyz="0 0 0" rpy="-1.5708 0 1.5708"/>
  </joint>

  <!-- For the sake of visibility, this is where the mujoco camera should end up -->
  <link name="camera_color_mujoco_frame"/>
  <joint name="camera_color_mujoco_joint" type="fixed">
    <parent link="camera_color_optical_frame"/>
    <child link="camera_color_mujoco_frame"/>
    <origin xyz="0 0 0" rpy="3.14159 0 0"/>
  </joint>

  <!-- In the URDF, the lidar sensor's Z-axis should point "up" so that the sensor data sweeps -->
  <!-- counter clockwise. We expect the X-axis to be in line with the first rangefinder's Z-axis. -->
  <link name="lidar_sensor_frame" />
  <joint name="lidar_sensor_link" type="fixed">
    <parent link="world"/>
    <child link="lidar_sensor_frame"/>
    <origin rpy="0 0 -1.5708" xyz="1.0 2.0 0"/>
  </joint>

  <!-- Inorder to test the model generation from tags within the URDF, we test that when both -->
  <!-- `use_mjcf_from_topic` and `use_pid` args are set to true -->
  <xacro:if value="$(eval use_mjcf_from_topic)">
    <xacro:if value="$(eval use_pid)">
      <mujoco_inputs>

        <!-- The contents of `raw_inputs` will be copied and pasted directly into the MJCF -->
        <raw_inputs>
          <option integrator="implicitfast"/>

          <default>
            <default class="visual">
              <geom group="2" type="mesh" contype="0" conaffinity="0"/>
            </default>
            <default class="collision">
              <geom group="3" type="mesh"/>
            </default>
          </default>

          <actuator>
            <motor name="joint1_motor" joint="joint1" gear="1"/>
            <motor name="joint2_motor" joint="joint2" gear="1"/>
          </actuator>

          <sensor>
            <rangefinder name="lidar" site="rf" />
          </sensor>
        </raw_inputs>

        <!-- Specific inputs that require processing from the conversion script-->
        <processed_inputs>
          <!-- Specifying decompose_mesh will set the `decompose` flag when using obj2mjcf -->
          <decompose_mesh mesh_name="shoulder_link" threshold="0.05"/>

          <!-- The camera with the specified values will be added at the specified site name. -->
          <!-- The position and quaterinion will be filled in by the converter -->
          <camera site="camera_color_optical_frame" name="camera" fovy="58" mode="fixed" resolution="640 480"/>

          <!-- Adds a lidar tag below a site tag to support a lidar sensor. -->
          <!-- In the URDF, we assume that that the sensor frame has the Z-axis pointed directly up in the sensor -->
          <!-- frame. This tag will create rangefinders in the MJCF between min_angle and max_angle at each -->
          <!-- angle_increment rotated about the replicate frame's Y axis. The hardware intercface then combines -->
          <!-- them into a single LaserScan message. -->
          <lidar ref_site="lidar_sensor_frame" sensor_name="rf" min_angle="-0.3" max_angle="0.3" angle_increment="0.025" />

          <!-- The element with the type and name as listed below will be modified with the remaining attributes -->
          <!-- If the attribute already existed, it will be overwritten -->
          <!-- Note that the type and name elements are required -->
          <modify_element type="joint" name="joint1" frictionloss="1.0" damping="2.0"/>
          <modify_element type="body" name="forearm" gravcomp="1.0"/>

        </processed_inputs>

        <!-- scene tag inside the xacro also allows to generate the mjcf description with the scene information -->
        <scene>
          <statistic center="0.4 0 0.4" extent="1"/>

          <visual>
            <headlight diffuse="0.6 0.6 0.6" ambient="0.1 0.1 0.1" specular="0 0 0"/>
            <rgba haze="0.15 0.25 0.35 1"/>
            <global azimuth="120" elevation="-20"/>
          </visual>

          <asset>
            <texture type="skybox" builtin="gradient" rgb1="0.3 0.5 0.7" rgb2="0 0 0" width="512" height="3072"/>
            <texture type="2d" name="groundplane" builtin="checker" mark="edge" rgb1="0.2 0.3 0.4" rgb2="0.1 0.2 0.3"
              markrgb="0.8 0.8 0.8" width="300" height="300"/>
            <material name="groundplane" texture="groundplane" texuniform="true" texrepeat="5 5"/>
          </asset>

          <worldbody>
            <light pos="0 0 1.5" dir="0 0 -1" directional="true"/>
          </worldbody>
        </scene>
      </mujoco_inputs>
    </xacro:if>
  </xacro:if>

  <!-- ROS2 Control Configuration -->
  <ros2_control name="MujocoSystem" type="system">
    <hardware>
      <plugin>mujoco_ros2_control/MujocoSystemInterface</plugin>

      <!-- Conditional mujoco_model parameter based on use_pid -->
      <xacro:if value="$(arg use_pid)">
        <param name="pids_config_file">$(find mujoco_ros2_control)/config/mujoco_pid.yaml</param>
      </xacro:if>

      <xacro:unless value="$(arg use_mjcf_from_topic)">
        <xacro:if value="$(arg use_pid)">
            <param name="mujoco_model">$(find mujoco_ros2_control)/test_resources/test_pid/scene_pid.xml</param>
        </xacro:if>

        <xacro:unless value="$(arg use_pid)">
          <param name="mujoco_model">$(find mujoco_ros2_control)/test_resources/scene.xml</param>
        </xacro:unless>
      </xacro:unless>

      <!-- Uncomment this to use the keyframe from shown file as the starting configuration. -->
      <!-- <param name="override_start_position_file">$(find mujoco_ros2_control)/config/start_positions.xml</param> -->

      <!-- Override the slowdown settings in the Simulate App and run at 3x speed -->
      <param name="sim_speed_factor">3.0</param>

      <!-- If set to true, will not launch the Simulate App window -->
      <param name="headless">$(arg headless)</param>

      <!-- Publish camera images at 6 hz -->
      <param name="camera_publish_rate">6.0</param>

      <!-- Publish lidar scans at 10 hz -->
      <param name="lidar_publish_rate">1.0</param>
    </hardware>
    <joint name="joint1">
      <command_interface name="position"/>
      <xacro:if value="$(arg use_pid)">
        <command_interface name="velocity"/>
      </xacro:if>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>

      <!-- Effort and torque are semantically different but map to the same underlying data. -->
      <state_interface name="effort"/>
      <state_interface name="torque"/>
    </joint>
    <joint name="joint2">
      <command_interface name="position"/>
      <xacro:if value="$(arg use_pid)">
        <command_interface name="velocity"/>
      </xacro:if>
      <state_interface name="position">
        <param name="initial_value">0.0</param>
      </state_interface>
      <state_interface name="velocity"/>

       <!-- Effort and torque are semantically different but map to the same underlying data. -->
      <state_interface name="effort"/>
      <state_interface name="torque"/>
    </joint>

    <!-- For cameras, the sensor name _must_ match the camera name in the MJCF -->
    <sensor name="camera">
      <!-- Parameters will be used as is -->
      <param name="frame_name">camera_color_mujoco_frame</param>
      <param name="info_topic">/camera/color/camera_info</param>
      <param name="image_topic">/camera/color/image_raw</param>
      <param name="depth_topic">/camera/aligned_depth_to_color/image_raw</param>
    </sensor>

    <!-- Lidar sensors are matched to a set of rangefinder sensors in the MJCF, which should be -->
    <!-- generated with the "<lidar>" inputs in the conversion script. The consiste of N rangefinders -->
    <!-- and will generally be of the form "<sensor_name>-01". These parameters should line up with -->
    <!-- those documented in the laserscan message. -->
    <sensor name="lidar">
      <param name="frame_name">lidar_sensor_frame</param>
      <param name="angle_increment">0.025</param>
      <param name="min_angle">-0.3</param>
      <param name="max_angle">0.3</param>
      <param name="range_min">0.05</param>
      <param name="range_max">10</param>
      <param name="laserscan_topic">/scan</param>
    </sensor>
  </ros2_control>
</robot>
